<script>
    const firebaseConfig = { databaseURL: "https://gps-retroexc-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const map = L.map('map', { zoomControl: false }).setView([-8.0942, -79.0101], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let flota = {};
    let modoActual = 'rt';
    let unidadEnFoco = null;
    let cacheDirecciones = {};

    function toggleMenu() {
        const m = document.getElementById('filter-menu');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function colorPorId(id) {
        const colores = ['#e67e22', '#9b59b6', '#2ecc71', '#3498db', '#f1c40f', '#e74c3c'];
        let hash = 0;
        for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
        return colores[Math.abs(hash) % colores.length];
    }

    async function cambiarModo(modo) {
        modoActual = modo;
        document.getElementById('btn-rt').classList.toggle('active', modo === 'rt');
        document.getElementById('btn-hist').classList.toggle('active', modo === 'hist');
        document.getElementById('hist-controls').style.display = (modo === 'hist') ? 'block' : 'none';
        limpiarMapa();
        if (modo === 'rt') { await cargarHistorialDia(); escucharRT(); }
    }

    function limpiarMapa() {
        Object.keys(flota).forEach(id => {
            map.removeLayer(flota[id].marker);
            map.removeLayer(flota[id].polyline);
            map.removeLayer(flota[id].puntosGroup);
        });
        flota = {};
        document.getElementById('lista-vehiculos').innerHTML = '';
        unidadEnFoco = null;
    }

    async function obtenerDireccion(lat, lon) {
        const key = `${lat.toFixed(4)},${lon.toFixed(4)}`;
        if (cacheDirecciones[key]) return cacheDirecciones[key];
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
            const data = await resp.json();
            const addr = data.display_name.split(',').slice(0, 3).join(',');
            cacheDirecciones[key] = addr;
            return addr;
        } catch (e) { return "Dirección no disponible"; }
    }

    async function cargarHistorialDia(fechaManual = null) {
        const hoy = fechaManual || new Date().toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        await db.ref('historial').once('value', (snap) => {
            snap.forEach((veh) => {
                veh.forEach((pto) => {
                    const d = pto.val();
                    if (d.fec === hoy) procesarDato(d, true);
                });
            });
        });
    }

    function escucharRT() {
        // Usamos .on('child_changed') y .on('child_added') para detectar cambios individuales
        db.ref('ultimo_estado').on('child_added', (snapshot) => {
            if (modoActual === 'rt') procesarDato(snapshot.val(), false);
        });
        db.ref('ultimo_estado').on('child_changed', (snapshot) => {
            if (modoActual === 'rt') procesarDato(snapshot.val(), false);
        });
    }

    async function procesarDato(data, esPrecarga) {
        const id = data.id;
        const pos = [parseFloat(data.lat), parseFloat(data.lon)];
        const color = colorPorId(id);

        if (!flota[id]) {
            flota[id] = { 
                visible: true, 
                coords: [], 
                lastPos: null,
                marker: L.circleMarker(pos, { radius: 10, color: '#fff', weight: 3, fillColor: color, fillOpacity: 1 }).addTo(map),
                polyline: L.polyline([], {color: color, weight: 3, opacity: 0.7}).addTo(map),
                puntosGroup: L.layerGroup().addTo(map)
            };
            crearItemLista(id);
        }

        // Solo agregar punto si la posición cambió significativamente
        if (!flota[id].lastPos || flota[id].lastPos[0] !== pos[0] || flota[id].lastPos[1] !== pos[1]) {
            flota[id].coords.push(pos);
            flota[id].lastPos = pos;
            flota[id].polyline.setLatLngs(flota[id].coords);
            L.circleMarker(pos, { radius: 2, color: color, stroke: false, fillOpacity: 0.4 }).addTo(flota[id].puntosGroup);
        }

        if (!esPrecarga) {
            flota[id].marker.setLatLng(pos);
            
            // SI ESTA UNIDAD ES LA QUE ESTAMOS VIENDO O SI NO HAY NINGUNA SELECCIONADA
            if (unidadEnFoco === id || unidadEnFoco === null) {
                if (unidadEnFoco === null) unidadEnFoco = id; // Auto-selecciona la primera que llegue
                actualizarUI(data); 
                map.panTo(pos); 
            }
        }
    }

    function crearItemLista(id) {
        const container = document.getElementById('lista-vehiculos');
        const div = document.createElement('div');
        div.className = 'filter-item';
        div.innerHTML = `<input type="checkbox" checked id="chk-${id}"> <span id="label-${id}">${id}</span>`;
        
        // Clic en el nombre para enfocar
        div.querySelector('span').onclick = () => enfocarUnidad(id);
        
        div.querySelector('input').onchange = (e) => {
            if (e.target.checked) { flota[id].marker.addTo(map); flota[id].polyline.addTo(map); flota[id].puntosGroup.addTo(map); }
            else { map.removeLayer(flota[id].marker); map.removeLayer(flota[id].polyline); map.removeLayer(flota[id].puntosGroup); }
        };
        container.appendChild(div);
    }

    async function enfocarUnidad(id) {
        unidadEnFoco = id;
        const p = flota[id].marker.getLatLng();
        map.flyTo(p, 16);
        
        // Forzar actualización inmediata de la UI al hacer clic
        db.ref(`ultimo_estado/${id}`).once('value', (s) => { 
            if (s.exists()) actualizarUI(s.val()); 
        });
        
        if (window.innerWidth < 768) toggleMenu();
    }

    async function actualizarUI(data) {
        // Esta función ahora se llama automáticamente cada vez que llega un dato RT de la unidad en foco
        document.getElementById('nombre-id').innerText = data.id;
        document.getElementById('color-indicator').style.background = colorPorId(data.id);
        document.getElementById('vel').innerText = data.vel || "0";
        document.getElementById('sat').innerText = data.sat || "0";
        document.getElementById('btp').innerText = data.btp || "--";
        document.getElementById('btc').innerText = data.btc || "--";
        document.getElementById('hor-val').innerText = data.hor || "--";
        document.getElementById('puntos').innerText = flota[data.id] ? flota[data.id].coords.length : "0";
        
        const addr = await obtenerDireccion(parseFloat(data.lat), parseFloat(data.lon));
        document.getElementById('direccion').innerText = addr;
    }

    function toggleAll(c) {
        Object.keys(flota).forEach(id => {
            const ck = document.getElementById(`chk-${id}`);
            if (ck) { ck.checked = c; ck.dispatchEvent(new Event('change')); }
        });
    }

    function cargarDatosHistorial() {
        const f = document.getElementById('input-fecha').value;
        if (!f) return;
        limpiarMapa();
        cargarHistorialDia(f.split('-').reverse().join('/'));
    }

    function descargarExcel() {
        const dataArr = [];
        Object.keys(flota).forEach(id => {
            // Aquí podrías enriquecer los datos del Excel si guardaras más info en la precarga
            flota[id].coords.forEach(c => dataArr.push({ Vehículo: id, Lat: c[0], Lon: c[1] }));
        });
        const ws = XLSX.utils.json_to_sheet(dataArr);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte");
        XLSX.writeFile(wb, "Reporte_BenJi.xlsx");
    }

    cambiarModo('rt');
</script>
