<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GPS Flota - Historial y Tiempo Real</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Mantenemos tus estilos originales y añadimos el selector de fecha */
        body { margin: 0; padding: 0; background: #f4f7f6; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        #menu-toggle {
            position: absolute; top: 15px; right: 15px;
            width: 45px; height: 45px; background: #2c3e50;
            color: white; border-radius: 12px; display: flex;
            justify-content: center; align-items: center;
            z-index: 1002; cursor: pointer; font-size: 22px;
        }

        #filter-menu {
            position: absolute; top: 70px; right: 15px;
            width: 260px; background: white; padding: 15px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001; display: none; border: 1px solid #ddd;
        }

        .mode-selector {
            display: flex; gap: 5px; margin-bottom: 15px;
            background: #eee; padding: 5px; border-radius: 10px;
        }

        .mode-btn {
            flex: 1; border: none; padding: 8px; border-radius: 8px;
            cursor: pointer; font-weight: bold; font-size: 0.8em;
        }

        .mode-btn.active { background: #e67e22; color: white; }

        #date-picker-container { margin-bottom: 15px; display: none; }
        input[type="date"] { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }

        /* Estilos de tu panel de info original */
        #info-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 94%; max-width: 450px; background: white;
            padding: 18px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .grid-data { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .box { background: #f8f9fa; padding: 8px; border-radius: 10px; border: 1px solid #edf0f2; }
        .label { color: #8a959e; font-size: 0.65em; text-transform: uppercase; font-weight: 800; }
        .value { font-weight: 700; font-size: 1.05em; color: #2c3e50; }
        .status-badge { font-size: 0.7em; background: #2ecc71; color: white; padding: 3px 10px; border-radius: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="menu-toggle" onclick="toggleMenu()">☰</div>

<div id="filter-menu">
    <div style="font-weight: bold; margin-bottom: 10px;">Modo de Vista</div>
    <div class="mode-selector">
        <button id="btn-rt" class="mode-btn active" onclick="setMode('rt')">EN VIVO</button>
        <button id="btn-hist" class="mode-btn" onclick="setMode('hist')">HISTORIAL</button>
    </div>

    <div id="date-picker-container">
        <label style="font-size: 0.8em; font-weight: bold;">Seleccionar Fecha:</label>
        <input type="date" id="hist-date" onchange="cargarHistorial()">
    </div>

    <div style="font-weight: bold; margin-bottom: 10px; border-top: 1px solid #eee; pt-10">Vehículos</div>
    <div id="lista-vehiculos"></div>
</div>

<div id="info-panel">
    <div class="header-panel" style="display:flex; justify-content: space-between;">
        <div class="unit-title" style="font-weight: bold;">
            <span id="nombre-id">Esperando datos...</span>
        </div>
        <div id="status-flota" class="status-badge">Sincronizando</div>
    </div>
    <div class="grid-data">
        <div class="box"><span class="label">Velocidad</span><br><span id="vel" class="value">0</span> <span style="font-size:0.7em">km/h</span></div>
        <div class="box"><span class="label">Satélites</span><br><span id="sat" class="value">0</span></div>
        <div class="box"><span class="label">Bat. Carro</span><br><span id="btc" class="value">--</span></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. CONFIGURACIÓN FIREBASE
    const firebaseConfig = {
        databaseURL: "https://gps-retroexc-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. MAPA
    const map = L.map('map', { zoomControl: false }).setView([-8.0942, -79.0101], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let flota = {};
    let modoActual = 'rt'; // 'rt' o 'hist'

    function toggleMenu() {
        const menu = document.getElementById('filter-menu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    // 3. CAMBIO DE MODO
    function setMode(modo) {
        modoActual = modo;
        document.getElementById('btn-rt').classList.toggle('active', modo === 'rt');
        document.getElementById('btn-hist').classList.toggle('active', modo === 'hist');
        document.getElementById('date-picker-container').style.display = (modo === 'hist') ? 'block' : 'none';
        
        limpiarMapa();
        if (modo === 'rt') escucharTiempoReal();
    }

    function limpiarMapa() {
        Object.values(flota).forEach(v => {
            map.removeLayer(v.marker);
            map.removeLayer(v.polyline);
        });
        flota = {};
        document.getElementById('lista-vehiculos').innerHTML = '';
    }

    // 4. LÓGICA TIEMPO REAL (Usa el nodo 'ultimo_estado')
    function escucharTiempoReal() {
        db.ref('ultimo_estado').on('value', (snapshot) => {
            if (modoActual !== 'rt') return;
            snapshot.forEach((child) => {
                const data = child.val();
                actualizarVehiculoEnMapa(data);
            });
        });
    }

    // 5. LÓGICA HISTORIAL (Usa el nodo 'historial')
    function cargarHistorial() {
        const fechaSelect = document.getElementById('hist-date').value; // Formato YYYY-MM-DD
        if (!fechaSelect) return;

        limpiarMapa();
        const fechaBusqueda = fechaSelect.split('-').reverse().join('/'); // Convierte a DD/MM/YYYY si así lo guardas

        db.ref('historial').once('value', (snapshot) => {
            snapshot.forEach((vehiculo) => {
                const id = vehiculo.key;
                const puntos = vehiculo.val();
                
                Object.values(puntos).forEach(p => {
                    // Solo mostramos puntos que coincidan con la fecha elegida
                    if (p.fec === fechaBusqueda || p.fec === fechaSelect) {
                        actualizarVehiculoEnMapa(p);
                    }
                });
            });
        });
    }

    function actualizarVehiculoEnMapa(data) {
        const id = data.id;
        const pos = [parseFloat(data.lat), parseFloat(data.lon)];

        if (!flota[id]) {
            const color = '#' + Math.floor(Math.random()*16777215).toString(16);
            flota[id] = {
                marker: L.circleMarker(pos, { radius: 8, color: '#white', weight: 2, fillColor: color, fillOpacity: 1 }).addTo(map),
                polyline: L.polyline([], {color: color, weight: 3}).addTo(map),
                coords: []
            };
            agregarALista(id);
        }

        flota[id].marker.setLatLng(pos);
        flota[id].coords.push(pos);
        flota[id].polyline.setLatLngs(flota[id].coords);
        
        // Actualizar UI con el último dato
        document.getElementById('nombre-id').innerText = data.id;
        document.getElementById('vel').innerText = data.vel;
        document.getElementById('sat').innerText = data.sat;
        document.getElementById('btc').innerText = data.btc;
    }

    function agregarALista(id) {
        const lista = document.getElementById('lista-vehiculos');
        const div = document.createElement('div');
        div.innerHTML = `<small>● ${id}</small>`;
        lista.appendChild(div);
    }

    // Iniciar en Tiempo Real
    setMode('rt');
</script>
</body>
</html>
