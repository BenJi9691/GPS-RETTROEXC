<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Panel de Control GPS - Flota BenJi</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* Botón de Menú */
        #menu-toggle {
            position: absolute; top: 15px; right: 15px;
            width: 45px; height: 45px; background: #e67e22;
            color: white; border-radius: 12px; display: flex;
            justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1002; cursor: pointer; font-size: 22px;
        }

        /* Menú Lateral */
        #filter-menu {
            position: absolute; top: 70px; right: 15px;
            width: 260px; background: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            z-index: 1001; display: none; max-height: 70vh; overflow-y: auto; border: 1px solid #ddd;
        }

        .section-title { font-weight: bold; margin: 15px 0 8px 0; color: #2c3e50; border-bottom: 2px solid #e67e22; font-size: 0.9em; }
        
        /* Selector de Modo */
        .mode-switch { display: flex; background: #f0f0f0; padding: 4px; border-radius: 8px; margin-bottom: 10px; }
        .mode-btn { flex: 1; border: none; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 0.75em; font-weight: bold; transition: 0.3s; }
        .mode-btn.active { background: #e67e22; color: white; }

        /* Lista de Vehículos */
        .filter-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85em; font-weight: 600; }
        .filter-item input { width: 16px; height: 16px; margin-right: 10px; accent-color: #e67e22; cursor: pointer; }

        /* Panel de Información (Tu diseño original mejorado) */
        #info-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 94%; max-width: 480px; background: white;
            padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .header-panel { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .unit-title { display: flex; align-items: center; font-size: 1.1em; font-weight: bold; color: #2c3e50; }
        #color-indicator { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 2px solid #fff; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        
        .grid-data { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .box { background: #f8f9fa; padding: 6px 8px; border-radius: 10px; border: 1px solid #edf0f2; }
        .label { color: #8a959e; font-size: 0.6em; text-transform: uppercase; font-weight: 800; display: block; }
        .value { font-weight: 700; font-size: 0.95em; color: #2c3e50; }
        .sub-val { font-size: 0.7em; color: #7f8c8d; font-weight: normal; }

        .status-badge { font-size: 0.65em; background: #2ecc71; color: white; padding: 2px 8px; border-radius: 20px; font-weight: bold; }
        input[type="date"] { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px; font-family: inherit; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="menu-toggle" onclick="toggleMenu()">☰</div>

<div id="filter-menu">
    <div class="section-title">MODO DE VISUALIZACIÓN</div>
    <div class="mode-switch">
        <button id="btn-rt" class="mode-btn active" onclick="cambiarModo('rt')">TIEMPO REAL</button>
        <button id="btn-hist" class="mode-btn" onclick="cambiarModo('hist')">HISTORIAL</button>
    </div>

    <div id="hist-controls" style="display:none;">
        <div class="section-title">FECHA DE CONSULTA</div>
        <input type="date" id="input-fecha" onchange="cargarDatos()">
    </div>

    <div class="section-title">UNIDADES DISPONIBLES</div>
    <div class="filter-item">
        <input type="checkbox" id="check-all" checked onclick="toggleAll(this.checked)"> <strong>MOSTRAR TODAS</strong>
    </div>
    <div id="lista-vehiculos"></div>
</div>

<div id="info-panel">
    <div class="header-panel">
        <div class="unit-title">
            <span id="color-indicator" style="background: #e67e22;"></span> 
            <span id="nombre-id">Iniciando...</span>
        </div>
        <div id="status-flota" class="status-badge">ONLINE</div>
    </div>

    <div class="grid-data">
        <div class="box"><span class="label">Velocidad</span><span id="vel" class="value">0</span> <span class="sub-val">km/h</span></div>
        <div class="box"><span class="label">Satélites</span><span id="sat" class="value">0</span></div>
        <div class="box"><span class="label">Puntos Hoy</span><span id="puntos" class="value">0</span></div>
        
        <div class="box"><span class="label">Bat. Carro</span><span id="btc" class="value">--</span> <span class="sub-val">V</span></div>
        <div class="box"><span class="label">Bat. GPS</span><span id="btp" class="value">--</span> <span class="sub-val">V</span></div>
        <div class="box"><span class="label">Hora</span><span id="hor-val" class="value">--:--</span></div>
    </div>

    <div style="margin-top: 10px; display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 8px;">
        <div>
            <span class="label">Coordenadas</span>
            <span id="coords-text" style="font-family: monospace; font-size: 0.8em; font-weight: bold;">0.000, 0.000</span>
        </div>
        <div style="text-align: right;">
            <span class="label">Fecha</span>
            <span id="fec-val" style="font-weight: bold; font-size: 0.8em;">--/--/--</span>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. CONFIGURACIÓN FIREBASE
    const firebaseConfig = { databaseURL: "https://gps-retroexc-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. MAPA
    const map = L.map('map', { zoomControl: false }).setView([-8.0942, -79.0101], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let flota = {}; // { ID: { marker, polyline, puntosGroup, visible, ultimoDato } }
    let modoActual = 'rt'; 

    function toggleMenu() {
        const m = document.getElementById('filter-menu');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function colorPorId(id) {
        const colores = ['#e67e22', '#9b59b6', '#2ecc71', '#3498db', '#f1c40f', '#e74c3c', '#1abc9c'];
        let hash = 0;
        for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
        return colores[Math.abs(hash) % colores.length];
    }

    // 3. CAMBIO DE MODO (RT / HISTORIAL)
    function cambiarModo(modo) {
        modoActual = modo;
        document.getElementById('btn-rt').className = (modo === 'rt') ? 'mode-btn active' : 'mode-btn';
        document.getElementById('btn-hist').className = (modo === 'hist') ? 'mode-btn active' : 'mode-btn';
        document.getElementById('hist-controls').style.display = (modo === 'hist') ? 'block' : 'none';
        
        // Limpiar todo al cambiar
        Object.keys(flota).forEach(id => eliminarVehiculoDelMapa(id));
        flota = {};
        document.getElementById('lista-vehiculos').innerHTML = '';
        
        if (modo === 'rt') {
            db.ref('ultimo_estado').off(); // Limpiar listeners previos
            cargarDatos();
        }
    }

    // 4. CARGA DE DATOS (Manejador principal)
    function cargarDatos() {
        if (modoActual === 'rt') {
            db.ref('ultimo_estado').on('value', (snapshot) => {
                snapshot.forEach((child) => procesarDato(child.val()));
            });
        } else {
            const fecha = document.getElementById('input-fecha').value.split('-').reverse().join('/'); // DD/MM/YYYY
            if (!fecha) return;
            
            // En historial, limpiamos y cargamos una vez
            Object.keys(flota).forEach(id => eliminarVehiculoDelMapa(id));
            flota = {};
            document.getElementById('lista-vehiculos').innerHTML = '';

            db.ref('historial').once('value', (snapshot) => {
                snapshot.forEach((vehiculo) => {
                    vehiculo.forEach((punto) => {
                        const d = punto.val();
                        if (d.fec === fecha) procesarDato(d);
                    });
                });
            });
        }
    }

    function procesarDato(data) {
        const id = data.id;
        const pos = [parseFloat(data.lat), parseFloat(data.lon)];
        const color = colorPorId(id);

        if (!flota[id]) {
            flota[id] = {
                visible: true,
                ultimoDato: data,
                coords: [],
                marker: L.circleMarker(pos, { radius: 10, color: '#fff', weight: 3, fillColor: color, fillOpacity: 1 }).addTo(map),
                polyline: L.polyline([], {color: color, weight: 3, opacity: 0.7}).addTo(map),
                puntosGroup: L.layerGroup().addTo(map)
            };
            crearCheckEnLista(id);
        }

        // Actualizar Memoria y Mapa
        flota[id].ultimoDato = data;
        flota[id].marker.setLatLng(pos);
        flota[id].coords.push(pos);
        flota[id].polyline.setLatLngs(flota[id].coords);
        
        // Puntitos de rastro (opcional)
        L.circleMarker(pos, { radius: 2, color: color, stroke: false, fillOpacity: 0.4 }).addTo(flota[id].puntosGroup);

        if (flota[id].visible) actualizarPanelInfo(data);
    }

    function crearCheckEnLista(id) {
        const container = document.getElementById('lista-vehiculos');
        const div = document.createElement('div');
        div.className = 'filter-item';
        div.innerHTML = `<input type="checkbox" checked id="check-${id}"> <span>${id}</span>`;
        div.querySelector('input').onchange = (e) => toggleVehiculo(id, e.target.checked);
        container.appendChild(div);
    }

    function toggleVehiculo(id, visible) {
        flota[id].visible = visible;
        if (visible) {
            flota[id].marker.addTo(map);
            flota[id].polyline.addTo(map);
            flota[id].puntosGroup.addTo(map);
            actualizarPanelInfo(flota[id].ultimoDato);
            map.panTo(flota[id].marker.getLatLng());
        } else {
            map.removeLayer(flota[id].marker);
            map.removeLayer(flota[id].polyline);
            map.removeLayer(flota[id].puntosGroup);
        }
    }

    function toggleAll(checked) {
        Object.keys(flota).forEach(id => {
            document.getElementById(`check-${id}`).checked = checked;
            toggleVehiculo(id, checked);
        });
    }

    function actualizarPanelInfo(data) {
        document.getElementById('nombre-id').innerText = data.id;
        document.getElementById('color-indicator').style.background = colorPorId(data.id);
        document.getElementById('vel').innerText = data.vel;
        document.getElementById('sat').innerText = data.sat;
        document.getElementById('btc').innerText = data.btc;
        document.getElementById('btp').innerText = data.btp;
        document.getElementById('fec-val').innerText = data.fec;
        document.getElementById('hor-val').innerText = data.hor;
        document.getElementById('coords-text').innerText = `${parseFloat(data.lat).toFixed(5)}, ${parseFloat(data.lon).toFixed(5)}`;
        document.getElementById('puntos').innerText = flota[data.id].coords.length;
    }

    function eliminarVehiculoDelMapa(id) {
        map.removeLayer(flota[id].marker);
        map.removeLayer(flota[id].polyline);
        map.removeLayer(flota[id].puntosGroup);
    }

    // Iniciar por defecto
    cambiarModo('rt');
</script>
</body>
</html>
