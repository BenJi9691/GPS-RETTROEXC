<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GPS Flota - Telemetría Nube</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        #menu-toggle {
            position: absolute; top: 15px; right: 15px;
            width: 45px; height: 45px; background: #e67e22;
            color: white; border-radius: 12px; display: flex;
            justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1002; cursor: pointer; font-size: 22px; transition: 0.3s;
        }
        #filter-menu {
            position: absolute; top: 70px; right: 15px;
            width: 240px; background: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            z-index: 1001; display: none;
            max-height: 50vh; overflow-y: auto; border: 1px solid #ddd;
        }
        .filter-header { font-weight: bold; margin-bottom: 12px; color: #2c3e50; border-bottom: 2px solid #e67e22; padding-bottom: 5px; }
        .filter-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.9em; font-weight: 500; }
        .filter-item input { width: 18px; height: 18px; margin-right: 12px; accent-color: #e67e22; cursor: pointer; }
        #info-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 94%; max-width: 450px; background: white;
            padding: 18px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .header-panel { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .unit-title { display: flex; align-items: center; font-size: 1.2em; font-weight: bold; color: #2c3e50; }
        #color-indicator { width: 14px; height: 14px; border-radius: 50%; margin-right: 10px; border: 2px solid #fff; }
        .grid-data { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .box { background: #f8f9fa; padding: 8px; border-radius: 10px; border: 1px solid #edf0f2; }
        .label { color: #8a959e; font-size: 0.65em; text-transform: uppercase; font-weight: 800; display: block; }
        .value { font-weight: 700; font-size: 1.05em; color: #2c3e50; }
        .status-badge { font-size: 0.7em; background: #e67e22; color: white; padding: 3px 10px; border-radius: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="menu-toggle" onclick="toggleMenu()">☰</div>
<div id="filter-menu">
    <div class="filter-header">Control de Flota</div>
    <div id="lista-vehiculos"></div>
</div>

<div id="info-panel">
    <div class="header-panel">
        <div class="unit-title"><span id="color-indicator"></span><span id="nombre-id">Cargando...</span></div>
        <div id="status-flota" class="status-badge">Nube Activa</div>
    </div>
    <div class="grid-data">
        <div class="box"><span class="label">Velocidad</span><span id="vel" class="value">0</span> <small>km/h</small></div>
        <div class="box"><span class="label">Satélites</span><span id="sat" class="value">0</span></div>
        <div class="box"><span class="label">Puntos</span><span id="puntos" class="value">0</span></div>
        <div class="box"><span class="label">Bat. Carro</span><span id="btc" class="value">--</span> <small>V</small></div>
        <div class="box"><span class="label">Bat. GPS</span><span id="btp" class="value">--</span> <small>V</small></div>
        <div class="box"><span class="label">Hora</span><span id="hor-val" class="value">--:--</span></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- CONFIG FIREBASE ---
    const firebaseConfig = { databaseURL: "https://gps-retroexc-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- MAPA ---
    const map = L.map('map', { zoomControl: false }).setView([-8.0942, -79.0101], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let flota = {};
    let seleccionados = new Set();

    function toggleMenu() {
        const menu = document.getElementById('filter-menu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    function colorPorId(id) {
        const colores = ['#e67e22', '#9b59b6', '#2ecc71', '#3498db', '#f1c40f'];
        let hash = 0;
        for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
        return colores[Math.abs(hash) % colores.length];
    }

    function procesarDato(data, esCargaInicial = false) {
        const id = data.id || "S-ID";
        const pos = [parseFloat(data.lat), parseFloat(data.lon)];

        if (!flota[id]) {
            const color = colorPorId(id);
            flota[id] = {
                marker: L.circleMarker(pos, { radius: 10, color: '#fff', weight: 3, fillColor: color, fillOpacity: 1 }).addTo(map),
                polyline: L.polyline([], {color: color, weight: 3, opacity: 0.6}).addTo(map),
                rutaCoords: []
            };
            seleccionados.add(id);
            agregarAMenu(id);
        }

        flota[id].marker.setLatLng(pos);
        flota[id].rutaCoords.push(pos);
        flota[id].polyline.setLatLngs(flota[id].rutaCoords);

        if (!esCargaInicial) {
            actualizarUI(data);
        }
    }

    function agregarAMenu(id) {
        const d = document.createElement('div');
        d.className = 'filter-item';
        d.innerHTML = `<input type="checkbox" checked> ${id}`;
        document.getElementById('lista-vehiculos').appendChild(d);
    }

    function actualizarUI(data) {
        document.getElementById('nombre-id').innerText = data.id;
        document.getElementById('vel').innerText = data.vel || "0";
        document.getElementById('sat').innerText = data.sat || "0";
        document.getElementById('btc').innerText = data.btc || "--";
        document.getElementById('btp').innerText = data.btp || "--";
        document.getElementById('hor-val').innerText = data.hor || "--:--";
        document.getElementById('puntos').innerText = flota[data.id].rutaCoords.length;
    }

    // CARGAR HISTORIAL DE FIREBASE
    db.ref('historial').once('value', (snap) => {
        const data = snap.val();
        if (data) {
            Object.keys(data).forEach(vehId => {
                Object.keys(data[vehId]).sort().forEach(ts => {
                    procesarDato(data[vehId][ts], true);
                });
            });
        }
    });

    // TIEMPO REAL MQTT
    const client = new Paho.MQTT.Client("broker.emqx.io", 8084, "web_" + Math.random());
    client.onMessageArrived = (m) => { procesarDato(JSON.parse(m.payloadString), false); };
    client.connect({ useSSL: true, onSuccess: () => client.subscribe("GPS-RETRO") });

</script>
</body>
</html>
