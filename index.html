<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GPS - FLOTA V2.2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #f4f7f6; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        .vehiculo-icon-container {
            display: flex; justify-content: center; align-items: center;
            width: 34px; height: 34px; border-radius: 50%;
            border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            font-size: 18px; background-color: white;
        }

        #menu-toggle {
            position: absolute; top: 15px; right: 15px;
            width: 45px; height: 45px; background: #e67e22;
            color: white; border-radius: 12px; display: flex;
            justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1002; cursor: pointer; font-size: 22px;
        }

        #filter-menu {
            position: absolute; top: 70px; right: 15px;
            width: 260px; background: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 1001; display: none;
            max-height: 70vh; overflow-y: auto; border: 1px solid #ddd;
        }

        /* --- Estilos del Modal de ExportaciÃ³n --- */
        #export-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 380px; background: white; z-index: 2000;
            padding: 20px; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1999; }
        .export-option { margin-bottom: 15px; }
        .export-list { max-height: 120px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 5px; }
        .btn-cancel { width: 100%; background: #95a5a6; color: white; border: none; padding: 10px; border-radius: 8px; margin-top: 5px; cursor: pointer; font-weight: bold; }

        .section-title { font-weight: bold; margin: 15px 0 8px 0; color: #2c3e50; border-bottom: 2px solid #e67e22; font-size: 0.85em; }
        .mode-switch { display: flex; background: #f0f0f0; padding: 4px; border-radius: 8px; margin-bottom: 10px; }
        .mode-btn { flex: 1; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.75em; font-weight: bold; }
        .mode-btn.active { background: #e67e22; color: white; }

        .btn-excel { width: 100%; background: #27ae60; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 0.8em; }

        .filter-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85em; font-weight: 600; cursor: pointer; }
        .filter-item input { width: 18px; height: 18px; margin-right: 10px; accent-color: #e67e22; }

        #info-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 94%; max-width: 500px; background: white;
            padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000;
        }
        .grid-data { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .box { background: #f8f9fa; padding: 6px 8px; border-radius: 10px; border: 1px solid #edf0f2; }
        .label { color: #8a959e; font-size: 0.55em; text-transform: uppercase; font-weight: 800; display: block; }
        .value { font-weight: 700; font-size: 0.9em; color: #2c3e50; }
        .highlight { background: #fff9c4; border: 1px solid #fbc02d; }
        .address-box { border-top: 1px solid #eee; padding-top: 8px; margin-top: 5px; }
        .status-badge { font-size: 0.65em; background: #2ecc71; color: white; padding: 2px 8px; border-radius: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="menu-toggle" onclick="toggleMenu()">â˜°</div>

<div id="filter-menu">
    <div class="section-title">MODO DE VISTA</div>
    <div class="mode-switch">
        <button id="btn-rt" class="mode-btn active" onclick="cambiarModo('rt')">TIEMPO REAL</button>
        <button id="btn-hist" class="mode-btn" onclick="cambiarModo('hist')">HISTORIAL</button>
    </div>
    <div id="hist-controls" style="display:none;">
        <div class="section-title">FECHA HISTÃ“RICA</div>
        <input type="date" id="input-fecha" onchange="cargarDatosHistorial()">
        <button class="btn-excel" onclick="abrirModalExportar()">ðŸ“Š EXPORTAR DATOS</button>
    </div>
    <div class="section-title">UNIDADES</div>
    <div class="filter-item">
        <input type="checkbox" id="check-all" checked onclick="toggleAll(this.checked)"> <span style="color:#e67e22">MOSTRAR TODAS</span>
    </div>
    <div id="lista-vehiculos"></div>
</div>

<div class="modal-overlay" id="overlay"></div>
<div id="export-modal">
    <h3 style="margin:0 0 15px 0; color:#2c3e50; border-bottom: 2px solid #27ae60; padding-bottom:5px;">Configurar Reporte Excel</h3>
    
    <div class="export-option">
        <span class="label">Rango de tiempo:</span>
        <select id="exp-rango" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
            <option value="1">Solo el dÃ­a seleccionado</option>
            <option value="3">Ãšltimos 3 dÃ­as</option>
            <option value="7">Ãšltimos 7 dÃ­as</option>
        </select>
    </div>

    <div class="export-option">
        <span class="label">Unidades a incluir:</span>
        <div id="exp-unidades-list" class="export-list">
            </div>
    </div>
    
    <button class="btn-excel" onclick="procesarExportacionAvanzada()">ðŸš€ GENERAR ARCHIVO</button>
    <button class="btn-cancel" onclick="cerrarModalExportar()">CANCELAR</button>
</div>

<div id="info-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom: 10px; align-items: center;">
        <div style="font-weight:bold;"><span id="color-indicator" style="display:inline-block;width:10px;height:10px;border-radius:50%;border:2px solid white;"></span> <span id="nombre-id">Sincronizando...</span></div>
        <div id="status-flota" class="status-badge">ONLINE</div>
    </div>
    <div class="grid-data">
        <div class="box"><span class="label">Velocidad</span><span id="vel" class="value">0</span> <span style="font-size:0.7em">km/h</span></div>
        <div class="box highlight"><span class="label">Fecha</span><span id="fec-val" class="value">--/--/--</span></div>
        <div class="box highlight"><span class="label">Hora</span><span id="hor-val" class="value">--:--:--</span></div>
        <div class="box"><span class="label">Bat. Carro</span><span id="btc" class="value">--</span> <span style="font-size:0.7em">V</span></div>
        <div class="box"><span class="label">Bat. GPS</span><span id="btp" class="value">--</span> <span style="font-size:0.7em">V</span></div>
        <div class="box"><span class="label">Puntos Hoy</span><span id="puntos" class="value">0</span></div>
    </div>
    <div class="address-box">
        <span class="label">UbicaciÃ³n Actual</span>
        <div id="direccion" style="font-size: 0.85em; font-weight: 600; color: #34495e;">Cargando direcciÃ³n...</div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const firebaseConfig = { databaseURL: "https://gps-retroexc-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const map = L.map('map', { zoomControl: false }).setView([-8.0942, -79.0101], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let flota = {};
    let modoActual = 'rt';
    let unidadEnFoco = null;

    function toggleMenu() {
        const m = document.getElementById('filter-menu');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function colorPorId(id) {
        const colores = ['#e67e22', '#9b59b6', '#2ecc71', '#3498db', '#f1c40f', '#e74c3c'];
        let hash = 0;
        for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
        return colores[Math.abs(hash) % colores.length];
    }

    // --- NUEVAS FUNCIONES DE EXPORTACIÃ“N ---
    function abrirModalExportar() {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('export-modal').style.display = 'block';
        const listContainer = document.getElementById('exp-unidades-list');
        listContainer.innerHTML = '';
        
        Object.keys(flota).forEach(id => {
            listContainer.innerHTML += `
                <div class="filter-item">
                    <input type="checkbox" class="chk-export" value="${id}" checked> <span>${id}</span>
                </div>`;
        });
    }

    function cerrarModalExportar() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('export-modal').style.display = 'none';
    }

    async function procesarExportacionAvanzada() {
        const rango = parseInt(document.getElementById('exp-rango').value);
        const checkboxes = document.querySelectorAll('.chk-export:checked');
        const idsAExportar = Array.from(checkboxes).map(cb => cb.value);
        
        if (idsAExportar.length === 0) {
            alert("Por favor selecciona al menos una unidad.");
            return;
        }

        const dataExcel = [];
        const registroUnicos = new Set(); // <--- SET PARA EVITAR DUPLICADOS
        const snapshot = await db.ref('historial').once('value');
        
        const fechasValidas = [];
        const fechaBase = document.getElementById('input-fecha').value 
            ? new Date(document.getElementById('input-fecha').value + "T00:00:00") 
            : new Date();

        for(let i=0; i < rango; i++) {
            let d = new Date(fechaBase);
            d.setDate(d.getDate() - i);
            fechasValidas.push(d.toLocaleDateString('es-PE', { day:'2-digit', month:'2-digit', year:'numeric' }));
        }

        snapshot.forEach(vehiculoSnap => {
            const idVehiculo = vehiculoSnap.key;
            if (idsAExportar.includes(idVehiculo)) {
                vehiculoSnap.forEach(puntoSnap => {
                    const d = puntoSnap.val();
                    if (fechasValidas.includes(d.fec)) {
                        // Crear una clave Ãºnica por punto (ID + Fecha + Hora)
                        const claveUnica = `${d.id}-${d.fec}-${d.hor}`;
                        
                        if (!registroUnicos.has(claveUnica)) { // <--- SOLO AGREGAR SI NO EXISTE
                            registroUnicos.add(claveUnica);
                            dataExcel.push({
                                Unidad: d.id,
                                Fecha: d.fec,
                                Hora: d.hor,
                                Latitud: d.lat,
                                Longitud: d.lon,
                                Velocidad: d.vel + " km/h",
                                Voltaje_Carro: d.btc + "V",
                                Voltaje_GPS: d.btp + "V"
                            });
                        }
                    }
                });
            }
        });

        if (dataExcel.length === 0) {
            alert("No se encontraron datos para los filtros seleccionados.");
            return;
        }

        const ws = XLSX.utils.json_to_sheet(dataExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte_Flota");
        XLSX.writeFile(wb, `Reporte_BenJi_${fechasValidas[0].replace(/\//g,'-')}.xlsx`);
        cerrarModalExportar();
    }

    function escucharRT() {
        db.ref('ultimo_estado').on('child_changed', (snapshot) => {
            const data = snapshot.val();
            if (modoActual === 'rt') {
                procesarDato(data, false);
                if (unidadEnFoco === data.id) {
                    actualizarUI(data);
                    map.panTo([parseFloat(data.lat), parseFloat(data.lon)]);
                }
            }
        });
        db.ref('ultimo_estado').on('child_added', (snapshot) => {
            if (modoActual === 'rt') procesarDato(snapshot.val(), false);
        });
    }

    async function cambiarModo(modo) {
        modoActual = modo;
        document.getElementById('btn-rt').classList.toggle('active', modo === 'rt');
        document.getElementById('btn-hist').classList.toggle('active', modo === 'hist');
        document.getElementById('hist-controls').style.display = (modo === 'hist') ? 'block' : 'none';
        limpiarMapa();
        if (modo === 'rt') { 
            await cargarHistorialDia(); 
            escucharRT(); 
        }
    }

    function limpiarMapa() {
        Object.keys(flota).forEach(id => {
            map.removeLayer(flota[id].marker);
            map.removeLayer(flota[id].polyline);
            map.removeLayer(flota[id].puntosGroup);
        });
        flota = {};
        document.getElementById('lista-vehiculos').innerHTML = '';
        unidadEnFoco = null;
    }

    async function cargarHistorialDia(fechaManual = null) {
        const hoy = fechaManual || new Date().toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const snapshot = await db.ref('historial').once('value');
        snapshot.forEach((veh) => {
            veh.forEach((pto) => {
                const d = pto.val();
                if (d.fec === hoy) procesarDato(d, true);
            });
        });
        const actualSnap = await db.ref('ultimo_estado').once('value');
        actualSnap.forEach(s => { if(flota[s.val().id]) procesarDato(s.val(), false); });
    }

    function procesarDato(data, esPrecarga) {
        const id = data.id;
        const pos = [parseFloat(data.lat), parseFloat(data.lon)];
        const color = colorPorId(id);

        if (!flota[id]) {
            const vIcon = L.divIcon({
                html: `<div class="vehiculo-icon-container" style="background-color: ${color};">ðŸš›</div>`,
                className: '',
                iconSize: [34, 34],
                iconAnchor: [17, 17]
            });

            flota[id] = { 
                coords: [], 
                marker: L.marker(pos, { icon: vIcon }).addTo(map),
                polyline: L.polyline([], {color: color, weight: 3, opacity: 0.7}).addTo(map),
                puntosGroup: L.layerGroup().addTo(map)
            };
            crearItemLista(id);
        }

        if (!esPrecarga) {
            flota[id].marker.setLatLng(pos).setZIndexOffset(1000);
        }

        const ult = flota[id].coords[flota[id].coords.length - 1];
        if (!ult || ult[0] !== pos[0] || ult[1] !== pos[1]) {
            flota[id].coords.push(pos);
            flota[id].polyline.setLatLngs(flota[id].coords);
            L.circleMarker(pos, { 
                radius: 4.5, 
                color: color, 
                stroke: false, 
                fillOpacity: 0.65 
            }).addTo(flota[id].puntosGroup);
        }

        if (!esPrecarga && !unidadEnFoco) enfocarUnidad(id);
    }

    function crearItemLista(id) {
        const container = document.getElementById('lista-vehiculos');
        const div = document.createElement('div');
        div.className = 'filter-item';
        div.innerHTML = `<input type="checkbox" checked class="chk-unidad" id="chk-${id}"> <span onclick="enfocarUnidad('${id}')">${id}</span>`;
        
        div.querySelector('input').onchange = (e) => {
            const visible = e.target.checked;
            if (visible) { 
                flota[id].marker.addTo(map); flota[id].polyline.addTo(map); flota[id].puntosGroup.addTo(map); 
            } else { 
                map.removeLayer(flota[id].marker); map.removeLayer(flota[id].polyline); map.removeLayer(flota[id].puntosGroup); 
            }
        };
        container.appendChild(div);
    }

    async function enfocarUnidad(id) {
        unidadEnFoco = id;
        const p = flota[id].marker.getLatLng();
        map.flyTo(p, 16);
        db.ref(`ultimo_estado/${id}`).once('value', (s) => { if (s.exists()) actualizarUI(s.val()); });
        if (window.innerWidth < 768) toggleMenu();
    }

    async function actualizarUI(data) {
        document.getElementById('nombre-id').innerText = data.id;
        document.getElementById('color-indicator').style.background = colorPorId(data.id);
        document.getElementById('vel').innerText = data.vel || "0";
        document.getElementById('fec-val').innerText = data.fec || "--/--/--";
        document.getElementById('hor-val').innerText = data.hor || "--:--:--";
        document.getElementById('btp').innerText = data.btp || "--";
        document.getElementById('btc').innerText = data.btc || "--";
        document.getElementById('puntos').innerText = flota[data.id] ? flota[data.id].coords.length : "0";
        
        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${data.lat}&lon=${data.lon}&zoom=18`);
            const json = await resp.json();
            document.getElementById('direccion').innerText = json.display_name.split(',').slice(0, 3).join(',');
        } catch (e) { document.getElementById('direccion').innerText = "DirecciÃ³n no disponible"; }
    }

    function toggleAll(c) {
        const checkboxes = document.querySelectorAll('.chk-unidad');
        checkboxes.forEach(cb => {
            if (cb.checked !== c) {
                cb.checked = c;
                cb.dispatchEvent(new Event('change'));
            }
        });
    }

    function cargarDatosHistorial() {
        const f = document.getElementById('input-fecha').value;
        if (!f) return;
        limpiarMapa();
        cargarHistorialDia(f.split('-').reverse().join('/'));
    }

    function descargarExcel() {
        abrirModalExportar();
    }

    cambiarModo('rt');
</script>
</body>
</html>
