<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BenJi GPS - 100% Funcional</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #f4f7f6; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* MENÚ LATERAL MEJORADO */
        #menu-toggle { position: absolute; top: 15px; right: 15px; width: 45px; height: 45px; background: #e67e22; color: white; border-radius: 12px; display: flex; justify-content: center; align-items: center; z-index: 1002; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #filter-menu { position: absolute; top: 70px; right: 15px; width: 250px; background: white; padding: 15px; border-radius: 15px; z-index: 1001; display: none; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }

        .section-title { font-weight: 800; font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; margin-bottom: 10px; border-bottom: 2px solid #f39c12; }
        
        /* BOTÓN TODAS REAL */
        #btn-seleccionar-todas { background: #fff4e5; padding: 10px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; border: 1px solid #ffcc80; cursor: pointer; transition: 0.3s; }
        #btn-seleccionar-todas:hover { background: #ffe0b2; }
        .filter-item { display: flex; align-items: center; padding: 6px 0; font-size: 0.9em; font-weight: 600; }
        .filter-item input { width: 18px; height: 18px; margin-right: 10px; accent-color: #e67e22; }

        /* PANEL DE INFO CON 7 ESPACIOS (INCLUYE FECHA) */
        #info-panel { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 94%; max-width: 500px; background: white; padding: 15px; border-radius: 20px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .grid-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .box { background: #f8f9fa; padding: 10px 5px; border-radius: 12px; border: 1px solid #eee; text-align: center; }
        .box.amarillo { background: #fff9c4; border: 1px solid #fbc02d; }
        .label { display: block; font-size: 0.55em; color: #95a5a6; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 0.95em; font-weight: 700; color: #2c3e50; }
        .status { font-size: 0.6em; background: #2ecc71; color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="menu-toggle" onclick="toggleMenu()">☰</div>

<div id="filter-menu">
    <div class="section-title">UNIDADES</div>
    <div id="btn-seleccionar-todas" onclick="clicEnTodas()">
        <input type="checkbox" id="check-all-master" checked>
        <span style="font-weight: 800; color: #d35400; margin-left: 10px;">TODAS</span>
    </div>
    <div id="lista-vehiculos"></div>
</div>

<div id="info-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <span id="color-indicator" style="display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:8px; background: #e67e22;"></span>
            <span id="nombre-id" style="font-weight:800; font-size:1.1em;">Seleccione Unidad</span>
        </div>
        <span class="status">ONLINE</span>
    </div>

    <div class="grid-info">
        <div class="box"><span class="label">Velocidad</span><span id="vel" class="value">0</span><small> km/h</small></div>
        
        <div class="box amarillo"><span class="label">Fecha</span><span id="fec-val" class="value">--/--/--</span></div>
        <div class="box amarillo"><span class="label">Hora</span><span id="hor-val" class="value">--:--:--</span></div>
        
        <div class="box"><span class="label">Bat. Carro</span><span id="btc" class="value">--</span><small>V</small></div>
        <div class="box"><span class="label">Bat. GPS</span><span id="btp" class="value">--</span><small>V</small></div>
        <div class="box"><span class="label">Satélites</span><span id="sat" class="value">0</span></div>
        
        <div class="box" style="grid-column: span 3; background: #f0f4f8;"><span class="label">Puntos Hoy</span><span id="pts-count" class="value">0</span></div>
    </div>
    
    <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
        <span class="label">Dirección Aproximada</span>
        <div id="direccion" style="font-size:0.8em; color:#34495e; font-weight:600;">Cargando ubicación...</div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const firebaseConfig = { databaseURL: "https://gps-retroexc-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const map = L.map('map', { zoomControl: false }).setView([-8.11, -79.02], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let flota = {};
    let unidadEnFoco = null;

    function toggleMenu() {
        const m = document.getElementById('filter-menu');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    // LÓGICA DEL BOTÓN TODAS
    function clicEnTodas() {
        const master = document.getElementById('check-all-master');
        master.checked = !master.checked;
        const checkboxes = document.querySelectorAll('.chk-unidad');
        checkboxes.forEach(c => {
            c.checked = master.checked;
            gestionarVisibilidad(c.dataset.id, c.checked);
        });
    }

    function gestionarVisibilidad(id, mostrar) {
        if (mostrar) {
            flota[id].marker.addTo(map);
            flota[id].linea.addTo(map);
        } else {
            map.removeLayer(flota[id].marker);
            map.removeLayer(flota[id].linea);
        }
    }

    db.ref('ultimo_estado').on('child_added', (s) => recibirDatos(s.val()));
    db.ref('ultimo_estado').on('child_changed', (s) => recibirDatos(s.val()));

    function recibirDatos(data) {
        const id = data.id;
        const pos = [parseFloat(data.lat), parseFloat(data.lon)];
        
        if (!flota[id]) {
            flota[id] = {
                marker: L.circleMarker(pos, { radius: 10, fillColor: '#e67e22', color: 'white', weight: 2, fillOpacity: 1 }).addTo(map),
                linea: L.polyline([], { color: '#e67e22', weight: 3 }).addTo(map),
                recorrido: []
            };
            crearFilaLista(id);
        }

        flota[id].marker.setLatLng(pos).bringToFront();
        flota[id].recorrido.push(pos);
        flota[id].linea.setLatLngs(flota[id].recorrido);

        if (unidadEnFoco === id) {
            actualizarInterfaz(data);
            map.panTo(pos);
        }
    }

    function crearFilaLista(id) {
        const lista = document.getElementById('lista-vehiculos');
        const div = document.createElement('div');
        div.className = 'filter-item';
        div.innerHTML = `<input type="checkbox" checked class="chk-unidad" data-id="${id}"> <span onclick="enfocar('${id}')">${id}</span>`;
        div.querySelector('input').onchange = (e) => gestionarVisibilidad(id, e.target.checked);
        lista.appendChild(div);
    }

    function enfocar(id) {
        unidadEnFoco = id;
        db.ref(`ultimo_estado/${id}`).once('value', s => actualizarInterfaz(s.val()));
        map.flyTo(flota[id].marker.getLatLng(), 16);
        if (window.innerWidth < 768) toggleMenu();
    }

    function actualizarInterfaz(data) {
        // AQUÍ SE ASIGNAN LOS DATOS A LOS NUEVOS ELEMENTOS
        document.getElementById('nombre-id').innerText = data.id;
        document.getElementById('vel').innerText = data.vel || "0";
        document.getElementById('fec-val').innerText = data.fec || "--/--/--"; // <--- FECHA
        document.getElementById('hor-val').innerText = data.hor || "--:--:--"; // <--- HORA
        document.getElementById('btc').innerText = data.btc || "--";
        document.getElementById('btp').innerText = data.btp || "--";
        document.getElementById('sat').innerText = data.sat || "0";
        document.getElementById('pts-count').innerText = flota[data.id] ? flota[data.id].recorrido.length : "0";

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${data.lat}&lon=${data.lon}`)
            .then(r => r.json()).then(j => {
                document.getElementById('direccion').innerText = j.display_name.split(',').slice(0,3).join(',');
            });
    }
</script>
</body>
</html>
